worker_processes auto;

events {
  worker_connections 2048;
}

env IIIF_SERVER_USERNAME;
env IIIF_SERVER_PASSWORD;

http {

  include ./mime.types;
  default_type application/octet-stream;

  sendfile on;
  keepalive_timeout 65;

  upstream api {
    server impresso-middle-layer:3030 max_fails=1;
    keepalive 64;
  }
  upstream public_api {
    server impresso-middle-layer-public:3030 max_fails=1;
    keepalive 64;
  }
  upstream admin {
    server impresso-user-admin:8000 max_fails=1;
  }
  upstream recsys {
    server impresso-recsys:8000;
    keepalive 64;
  }
  upstream auth-service {
    server auth-service:8087;
    keepalive 64;
  }
  upstream iiif-images {
    server iiif-impresso.epfl.ch:443 max_fails=3 fail_timeout=10s;
    keepalive 64;
  }
  upstream audio-data {
    server dhlab-audio-data.epfl.ch:443 max_fails=3 fail_timeout=10s;
    keepalive 64;
  }

  proxy_cache_path /var/cache/nginx_iiif levels=1:2 keys_zone=iiif_cache:10m inactive=60m;

  log_format main '$remote_addr - $remote_user [$time_local] "$request" '
  '$status $body_bytes_sent "$http_referer" '
  '"$http_user_agent" "$http_x_forwarded_for"';

  access_log /dev/stdout main;
  error_log /dev/stderr notice;

  map $http_origin $cors_origin {
    # Default value for disallowed origins (empty string)
    default "";
    
    # Allowed origins
    "https://impresso-project.ch" "https://impresso-project.ch";
    "https://dev.impresso-project.ch" "https://dev.impresso-project.ch";
    
    # Optional: Allow development/testing origins 
    "~^(http|https):\/\/(localhost|127\.0\.0\.1)(:\d+)?$" $http_origin;
  }

  server {
    listen 80;
    # no need to define specific names - just accept any hostname
    # server_name dcv-dw01_impresso.uni.lu dev.impresso-project.ch localhost;
    default_type "text/html";


    set_by_lua_block $iiif_auth {
      local username = os.getenv("IIIF_SERVER_USERNAME")
      local password = os.getenv("IIIF_SERVER_PASSWORD")

      return "Basic " .. ngx.encode_base64(username .. ":" .. password)
    }

    location / {
      proxy_pass https://impresso.github.io;
      proxy_intercept_errors on;

      proxy_redirect default;
      proxy_buffering off;
      proxy_set_header Host impresso.github.io;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Protocol $scheme;

      # allow GitHub to pass caching headers instead of using our own
      expires off;
    }

    # Widget for embedding
    location /widget/ {
      alias /opt/impresso-frontend/widget/;
      try_files $uri $uri/ /widget/index.html;

      # CORS headers for iframe embedding - allow embedding on any domain
      add_header 'Access-Control-Allow-Origin' '*' always;

      # Handle OPTIONS requests for CORS preflight
      if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Origin, X-Requested-With, Content-Type, Accept' always;
        add_header 'Access-Control-Max-Age' 86400 always;
        return 204;
      }
    }
    # institution-access
    location /institutions-access {
      alias /opt/impresso-frontend/institutions-access;
      try_files $uri $uri/ /index.html = 404;
    }
    # Webapp
    location /app {
      alias /opt/impresso-frontend;
      try_files $uri $uri/ /index.html = 404;
    }

    # Datalab
    location /datalab {
      alias /opt/impresso-datalab;
      try_files $uri $uri/ /index.html = 404;
      # auth_basic "Restricted";
      # auth_basic_user_file /etc/nginx/extra_config_files/datalab.htpasswd;
    }

    # Web app static files
    location ~ /app/static/*\.(?:css|gif|htc|ico|js|jpe?g|png|swf)$ {
      expires max;
      log_not_found off;
      ## No need to bleed constant updates. Send the all shebang in one
      ## fell swoop.
      tcp_nodelay off;
      ## Set the OS file cache.
      open_file_cache max=1000 inactive=120s;
      open_file_cache_valid 45s;
      open_file_cache_min_uses 2;
      open_file_cache_errors off;
    }

    ## More static assets
    location ~ /assets/*\.(?:css|gif|htc|ico|js|jpe?g|png|swf)$ {
      expires max;
      log_not_found off;
      ## No need to bleed constant updates. Send the all shebang in one
      ## fell swoop.
      tcp_nodelay off;
      ## Set the OS file cache.
      open_file_cache max=1000 inactive=120s;
      open_file_cache_valid 45s;
      open_file_cache_min_uses 2;
      open_file_cache_errors off;
    }

    # internal API
    location /api {
      rewrite /api/(.*) /$1 break;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_http_version 1.1;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $host;
      proxy_pass http://api;
      proxy_redirect off;
      proxy_read_timeout 240s;
    }

    # Api powered image proxy
    location /proxy {
      rewrite /api/(.*) /$1 break;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_http_version 1.1;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $host;
      proxy_pass http://api;
      proxy_redirect off;
      proxy_read_timeout 240s;
    }

    # Public API
    location /public-api/v1 {
      rewrite /public-api/v1/(.*) /$1 break;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_http_version 1.1;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Prefix '/public-api/v1';
      proxy_set_header Host $host;
      proxy_pass http://public_api;
      proxy_redirect off;
      proxy_read_timeout 240s;
    }

    # Admin portal
    location /admin {
      proxy_pass http://admin;
      proxy_pass_request_headers on;
      proxy_no_cache $cookie_nocache $arg_nocache$arg_comment;
      proxy_no_cache $http_pragma $http_authorization;
      proxy_cache_bypass $cookie_nocache $arg_nocache $arg_comment;
      proxy_cache_bypass $http_pragma $http_authorization;
    }

    # Recommender system
    location /recsys {
      rewrite /recsys/(.*) /$1 break;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_http_version 1.1;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $host;
      proxy_pass http://recsys;
      proxy_pass_request_headers on;

      proxy_redirect off;
      proxy_read_timeout 240s;
    }

    # CSV downloads
    location /protected-media {
      internal;
      # Location-specific logging
      # access_log /var/log/nginx/internal_redirect.access.log combined;
      # error_log /var/log/nginx/internal_redirect.error.log warn;
      alias /opt/impresso-user-media;
    }

    location @auth_failed {
      # Check the redirect URL in case auth service
      # wants to redirect the user to a "forbidden" image
      if ($redirect_url != "") {
          return 302 $redirect_url;
      }
      return 403 "Access Denied";
    }

    # Media files - audio manifests
    location ~ ^/media/iiif/.*\.json$ {
      rewrite ^/media/iiif/(.*)$ /iiif/3/$1 break;

      proxy_set_header Authorization $iiif_auth;
      proxy_hide_header Set-Cookie;
      proxy_hide_header 'Access-Control-Allow-Origin';

      # Caching configuration
      proxy_cache iiif_cache; # Use the cache zone defined in http block
      proxy_cache_valid 200 1d; # Cache 200 responses for 1 day
      proxy_cache_valid 404 1m; # Cache 404s for 1 minute
      proxy_cache_key "$scheme$request_method$host$request_uri$http_authorization"; # Cache key including auth
      proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
      add_header X-Cache-Status $upstream_cache_status; # Debug header

      # CORS headers
      add_header 'Access-Control-Allow-Origin' $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;

      # Handle OPTIONS requests
      if ($request_method = 'OPTIONS') {
        # Required headers for preflight
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Origin, X-Requested-With, Content-Type, Accept' always;
        add_header 'Access-Control-Max-Age' 86400 always; # Cache preflight results for 1 day

        # Terminate preflight request
        return 204;
      }

      # 1. Reset Content-Length in the header filter
      header_filter_by_lua_file /usr/local/openresty/nginx/scripts/header_filter.lua;

      # 2. Modify the response body in the body filter
      # Replace `id` fields to point to our domain instead of the upstream IIIF server
      # Otherwise IIIF viewers will try to load images from the upstream server directly.
      body_filter_by_lua_file /usr/local/openresty/nginx/scripts/body_filter.lua;

      proxy_pass https://iiif-images;
    }

    # Media files - iiif
    location ~ ^/media/iiif/.*\.(png|jpg|jpeg)$ {

      # First, check with the auth service if the user has access
      # User auth credentials are in the cookie
      # Content auth credentials are in the manifset
      auth_request /_auth/bitwise-and/cookie-bitmap/content-item-explore-bitmap/with-quota-check;
            
      # Capture custom header from auth response
      # To handle redirect from auth service
      auth_request_set $redirect_url $upstream_http_x_redirect_url;
      error_page 403 = @auth_failed;

      rewrite ^/media/iiif/(.*)$ /iiif/3/$1 break;

      proxy_set_header Authorization $iiif_auth;
      proxy_hide_header Set-Cookie;
      proxy_hide_header 'Access-Control-Allow-Origin';

      # Caching configuration
      proxy_cache iiif_cache; # Use the cache zone defined in http block
      proxy_cache_valid 200 1d; # Cache 200 responses for 1 day
      proxy_cache_valid 404 1m; # Cache 404s for 1 minute
      proxy_cache_key "$scheme$request_method$host$request_uri$http_authorization"; # Cache key including auth
      proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
      add_header X-Cache-Status $upstream_cache_status; # Debug header

      # CORS headers
      add_header 'Access-Control-Allow-Origin' $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;

      # Handle OPTIONS requests
      if ($request_method = 'OPTIONS') {
        # Required headers for preflight
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Origin, X-Requested-With, Content-Type, Accept' always;
        add_header 'Access-Control-Max-Age' 86400 always; # Cache preflight results for 1 day

        # Terminate preflight request
        return 204;
      }

      proxy_pass https://iiif-images;
    }

    # Media files - audio manifests
    location ~ ^/media/audio/.*/manifest\.json$ {
      rewrite ^/media/audio/(.*)$ /$1 break;

      proxy_set_header Host umd-mith.github.io;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Protocol $scheme;
      proxy_buffering off;

      proxy_hide_header Set-Cookie;
      proxy_hide_header 'Access-Control-Allow-Origin';

      # CORS headers
      add_header 'Access-Control-Allow-Origin' $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;

      # Handle OPTIONS requests
      if ($request_method = 'OPTIONS') {
        # Required headers for preflight
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Origin, X-Requested-With, Content-Type, Accept' always;
        add_header 'Access-Control-Max-Age' 86400 always; # Cache preflight results for 1 day

        # Terminate preflight request
        return 204;
      }

      proxy_pass https://audio-data;
      proxy_redirect default;
    }

    # Media files - audio
    location ~ ^/media/audio/.*\.mp3$ {

      # First, check with the auth service if the user has access
      # User auth credentials are in the cookie
      # Content auth credentials are in the manifset
      auth_request /_auth/bitwise-and/cookie-bitmap/iiif-presentation-manifest;

      rewrite ^/media/audio/(.*)$ /$1 break;

      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Protocol $scheme;
      proxy_buffering off;

      proxy_hide_header Set-Cookie;
      proxy_hide_header 'Access-Control-Allow-Origin';

      # CORS headers
      add_header 'Access-Control-Allow-Origin' $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;

      # Handle OPTIONS requests
      if ($request_method = 'OPTIONS') {
        # Required headers for preflight
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Origin, X-Requested-With, Content-Type, Accept' always;
        add_header 'Access-Control-Max-Age' 86400 always; # Cache preflight results for 1 day

        # Terminate preflight request
        return 204;
      }

      proxy_pass https://audio-data;
      proxy_redirect default;
    }

    # Internal authentication endpoint to check access to media files
    location /_auth {
      internal;

      # Remove /_auth prefix before forwarding to upstream
      rewrite ^/_auth/(.*) /$1 break;

      # Pass the original request information to the authentication service
      proxy_pass http://auth-service;
      proxy_pass_request_body off;
      proxy_set_header Content-Length "";

      # Pass the original URI before any rewrite occurs
      proxy_set_header X-Original-URI $request_uri;

      # Pass possible prefixes to strip
      proxy_set_header X-Prefix-Strip "/media/audio,/media/iiif";

      proxy_set_header X-Original-Method $request_method;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-Host $host;
      # disabled proto to fall back to https
      # proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Port $server_port;

      # Cache auth responses to improve performance
      proxy_cache_valid 200 30m;
    }
  }
}